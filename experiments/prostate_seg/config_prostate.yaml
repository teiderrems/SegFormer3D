######################################################
## Configuration pour segmentation de prostate avec SegFormer3D
## 
## Usage:
##   python train_scripts/trainer_ddp.py --config experiments/prostate_seg/config_prostate.yaml
######################################################

# ============ TRAINING PARAMETERS (pour compatibilité) ============
training_parameters:
  num_epochs: 5
  print_every: 5
  calculate_metrics: true
  checkpoint_save_dir: "./experiments/prostate_seg/checkpoints"
  cutoff_epoch: 2
  gradient_accumulation_steps: 1
  mixed_precision: "no"
  trainer_type: "segmentation"
  min_lr: 1e-6

# ============ EMA (Exponential Moving Average) ============
ema:
  enabled: false
  ema_decay: 0.999
  val_ema_every: 5

# ============ WARMUP SCHEDULER ============
warmup_scheduler:
  enabled: false
  warmup_epochs: 10
  start_factor: 0.001

# ============ LOGGING ============
logging:
  project_name: "segformer3d-prostate"
  entity: "osu"
  offline: false

# ============ SLIDING WINDOW INFERENCE ============
sliding_window_inference:
  roi: [96, 96, 96]      # Taille de la fenêtre pour l'inférence
  sw_batch_size: 4       # Batch size pour sliding window

# ============ DATA ============
# Format: prostate_seg (charge depuis .pt prétraités)
data:
  dataset_type: "prostate_seg"  # Nouveau dataset pour prostate
  
  # Arguments du dataset
  dataset_args:
    # Répertoire contenant train.csv, validation.csv et dossiers prétraités
    root: "./data/prostate_data"
    train: true
    # Optionnel: chemin personnalisé au fichier CSV
    split_file: "./data/prostate_data/train.csv"
    # Taille cible pour redimensionner les données (à la volée)
    target_size: 96

# ============ MODEL ============
model:
  # Paramètres essentiels pour prostate seul
  name: "segformer3d"
  in_channels: 1       # T2 seulement (pas d'ADC disponible)
  num_classes: 2       # background + prostate (pas de bandelettes)
  patch_size: 8        # Taille des patches
  embed_dim: 64        # Dimension d'embedding
  num_layers: 4        # Nombre de couches encoder
  num_heads: 4         # Nombre de heads attention
  mlp_ratio: 4         # Ratio hidden dim / embed dim
  qkv_bias: true
  drop_rate: 0.1
  attn_drop_rate: 0.0
  drop_path_rate: 0.1
  use_checkpoint: false
  use_abs_pos_embed: true

# ============ DATALOADER ============
dataloader:
  batch_size: 2
  shuffle: true
  num_workers: 0
  drop_last: true
  train_loader:
    batch_size: 2
    shuffle: true
    num_workers: 0
    drop_last: true
  val_loader:
    batch_size: 2
    shuffle: false
    num_workers: 0
    drop_last: false

# ============ AUGMENTATION ============
augmentation:
  # Augmentations MONAI appliquées durant entraînement
  # Les augmentations sont plus agressives pour prostate car dataset petit
  augmentations:
    - type: "RandRotate90d"
      prob: 0.5
      spatial_axes: [[1, 2], [0, 2], [0, 1]]
    
    - type: "RandAffined"
      prob: 0.2
      rotate_range: [[-0.3, 0.3], [-0.3, 0.3], [-0.3, 0.3]]
      shear_range: [[-0.2, 0.2], [-0.2, 0.2]]
      translate_range: [[-50, 50], [-50, 50], [-50, 50]]
      scale_range: [[-0.2, 0.2], [-0.2, 0.2], [-0.2, 0.2]]
    
    - type: "RandGaussianNoised"
      prob: 0.1
      std: 0.01
    
    - type: "RandFlipd"
      prob: 0.2
      spatial_axis: [1, 2]

# ============ TRAINING OPTIMISATION ============
optimization:
  optimizer: "adamw"
  
  # Learning rate configuration
  learning_rate: 1.0e-3
  weight_decay: 1.0e-4
  
  # Scheduler parameters
  scheduler:
    type: "cosine"  # Options: "cosine", "exponential", "step", "linear"
    T_max: 5  # Must match num_epochs above
    eta_min: 1.0e-6
    restart: false
    
    # Options for other schedulers
    gamma: 0.95  # For exponential
    step_size: 10  # For step scheduler
    factor: 0.5  # For step scheduler

# ============ LOSS FUNCTION ============
loss:
  type: "DiceCELoss"  # Options: DiceLoss, DiceCELoss, CELoss, FocalLoss
  
  # Loss function parameters
  ce_weight: 1.0           # Weight for cross-entropy component
  dice_weight: 1.0         # Weight for dice component
  squared_pred: false      # Whether to square predictions before dice
  jaccard: false           # Use Jaccard loss instead of Dice
  reduction: "mean"        # Type of reduction
  
  # Class weighting (optional)
  # Useful for imbalanced datasets
  # class_weights: [0.2, 1.0]  # More weight to prostate class (1)

# ============ VALIDATION ============
validation:
  val_every: 1          # Run validation every N epochs
  save_every: 1         # Save checkpoint every N epochs
  save_best: true       # Save best model based on validation loss
  early_stopping: 50    # Stop after N epochs without improvement (-1 to disable)

# ============ MONITORING ============
monitoring:
  track_loss: true
  track_metrics: true
  metrics: [dice, hausdorff, surface_dice]  # Metrics to calculate
